name: Rotating Domains Checker

on:
  # Automatic run daily at 02:00 UTC
  schedule:
    - cron: '0 2 * * *'
  # Manual run with mode selection
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: false
        default: 'prod_live'
        type: choice
        options:
          - ''              # Use config.yml setting
          - 'prod_live'     # Production mode with changes
          - 'prod_dry'      # Production mode without changes (git operations simulation)
          - 'test_live'     # Test directory with changes
          - 'test_dry'      # Test directory without changes (git operations simulation)

      config-path:
        description: 'Path to configuration file'
        required: false
        default: './rdc_config.yml'
        type: string

      filters-path:
        description: 'Path to filters directory'
        required: false
        default: './'
        type: string

jobs:
  check-domains:
    name: Rotating Domains Checker
    runs-on: ubuntu-latest

    permissions:
      contents: write          # Required for commits
      pull-requests: write     # Required for PR creation
      actions: read            # Required for reading workflow info

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ðŸš€ Run Rotating Domains Checker
        run: |
          # Configure git user for commits
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Clone Rotating Domains Checker repository (public, no token needed)
          git clone https://github.com/Alex-302/RotatingDomainsChecker.git /tmp/checker
          cd /tmp/checker
          npm install
          npm run build

          # Return to filters repository and run checker
          cd $GITHUB_WORKSPACE
          node /tmp/checker/dist/index.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_CONFIG_PATH: ${{ github.event.inputs.config-path || './config.yml' }}
          INPUT_MODE: ${{ github.event.inputs.mode || '' }}
          INPUT_FILTERS_PATH: ${{ github.event.inputs.filters-path || './' }}

      - name: ðŸ“‹ Upload log file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotating-domains-checker-log
          path: logs/rotating-domains-checker.log
          retention-days: 7
